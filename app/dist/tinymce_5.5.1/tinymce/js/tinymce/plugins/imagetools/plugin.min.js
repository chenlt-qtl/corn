!function(){"use strict";var t,e,n,r,o=function(t){var e=t;return{get:function(){return e},set:function(t){e=t}}},i=tinymce.util.Tools.resolve("tinymce.PluginManager"),u=tinymce.util.Tools.resolve("tinymce.util.Tools"),a=function(){},c=function(t){return function(){return t}},s=c(!1),f=c(!0),l=function(){return d},d=(t=function(t){return t.isNone()},{fold:function(t,e){return t()},is:s,isSome:s,isNone:f,getOr:n=function(t){return t},getOrThunk:e=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:c(null),getOrUndefined:c(void 0),or:n,orThunk:e,map:l,each:a,bind:l,exists:s,forall:f,filter:l,equals:t,equals_:t,toArray:function(){return[]},toString:c("none()")}),m=function(t){var e=c(t),n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:f,isNone:s,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:n,orThunk:n,map:function(e){return m(e(t))},each:function(e){e(t)},bind:r,exists:r,forall:r,filter:function(e){return e(t)?o:d},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(s,(function(e){return n(t,e)}))}};return o},h={some:m,none:l,from:function(t){return null===t||void 0===t?d:m(t)}},g=function(t){return!(null===(e=t)||void 0===e);var e},v=(r="function",function(t){return typeof t===r});function p(t,e){return b(document.createElement("canvas"),t,e)}function y(t){var e=p(t.width,t.height);return w(e).drawImage(t,0,0),e}function w(t){return t.getContext("2d")}function b(t,e,n){return t.width=e,t.height=n,t}var I,T,_,R,U=window.Promise?window.Promise:(I=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],C(t,A(j,this),A(x,this))},T=window,_=I.immediateFn||"function"==typeof T.setImmediate&&T.setImmediate||function(t){setTimeout(t,1)},R=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},I.prototype["catch"]=function(t){return this.then(null,t)},I.prototype.then=function(t,e){var n=this;return new I((function(r,o){E.call(n,new k(t,e,r,o))}))},I.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Array.prototype.slice.call(1===t.length&&R(t[0])?t[0]:t);return new I((function(t,e){if(0===n.length)return t([]);for(var o=n.length,i=0;i<n.length;i++)!function i(u,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var c=a.then;if("function"==typeof c)return void c.call(a,(function(t){i(u,t)}),e)}n[u]=a,0==--o&&t(n)}catch(r){e(r)}}(i,n[i])}))},I.resolve=function(t){return t&&"object"==typeof t&&t.constructor===I?t:new I((function(e){e(t)}))},I.reject=function(t){return new I((function(e,n){n(t)}))},I.race=function(t){return new I((function(e,n){for(var r=0,o=t;r<o.length;r++)o[r].then(e,n)}))},I);function A(t,e){return function(){return t.apply(e,arguments)}}function E(t){var e=this;null!==this._state?_((function(){var r,o=e._state?t.onFulfilled:t.onRejected;if(null!==o){try{r=o(e._value)}catch(n){return void t.reject(n)}t.resolve(r)}else(e._state?t.resolve:t.reject)(e._value)})):this._deferreds.push(t)}function j(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void C(A(e,t),A(j,this),A(x,this))}this._state=!0,this._value=t,L.call(this)}catch(n){x.call(this,n)}}function x(t){this._state=!1,this._value=t,L.call(this)}function L(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];E.call(this,n)}this._deferreds=[]}function k(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function C(t,e,n){var r=!1;try{t((function(t){r||(r=!0,e(t))}),(function(t){r||(r=!0,n(t))}))}catch(i){if(r)return;r=!0,n(i)}}function O(t){var e,n=t.src;return 0===n.indexOf("data:")?S(n):(e=n,new U((function(t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.onload=function(){200===this.status&&t(this.response)},r.onerror=function(){var t,e=this;n(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+e.status+" downloading image"))},r.send()})))}function P(t){return new U((function(e,n){var r=URL.createObjectURL(t),o=new Image,i=function(){o.removeEventListener("load",u),o.removeEventListener("error",a)};function u(){i(),e(o)}function a(){i(),n("Unable to load data of type "+t.type+": "+r)}o.addEventListener("load",u),o.addEventListener("error",a),o.src=r,o.complete&&u()}))}function S(t){return new U((function(e,n){(function(t){var e=t.split(","),n=/data:([^;]+)/.exec(e[0]);if(!n)return h.none();for(var r=n[1],o=e[1],i=atob(o),u=i.length,a=Math.ceil(u/1024),c=new Array(a),s=0;s<a;++s){for(var f=1024*s,l=Math.min(1024+f,u),d=new Array(l-f),m=f,g=0;m<l;++g,++m)d[g]=i[m].charCodeAt(0);c[s]=new Uint8Array(d)}return h.some(new Blob(c,{type:r}))})(t).fold((function(){n("uri is not base64: "+t)}),e)}))}function M(t,e,n){return e=e||"image/png",v(HTMLCanvasElement.prototype.toBlob)?new U((function(r,o){t.toBlob((function(t){t?r(t):o()}),e,n)})):S(t.toDataURL(e,n))}function B(t){return P(t).then((function(t){var e;e=t,URL.revokeObjectURL(e.src);var n,r,o=p((r=t).naturalWidth||r.width,(n=t).naturalHeight||n.height);return w(o).drawImage(t,0,0),o}))}var N=P,D=O,F=function(t,e){return function(t,e,n){for(var r=0,o=t.length;r<o;r++){var i=t[r];if(e(i,r))return h.some(i);if(n(i,r))break}return h.none()}(t,e,s)};function H(t,e,n){var r=e.type;function o(e,n){return t.then((function(t){return o=n,r=(r=e)||"image/png",t.toDataURL(r,o);var r,o}))}return{getType:c(r),toBlob:function(){return U.resolve(e)},toDataURL:c(n),toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then((function(t){return M(t,e,n)}))},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then((function(t){return t.split(",")[1]}))},toCanvas:function(){return t.then(y)}}}function q(t){return e=t,new U((function(t){var n=new FileReader;n.onloadend=function(){t(n.result)},n.readAsDataURL(e)})).then((function(e){return H(B(t),t,e)}));var e}function z(t,e){return M(t,e).then((function(e){return H(U.resolve(t),e,t.toDataURL())}))}function $(t,e){return t.toCanvas().then((function(n){return function(t,e,n){var r=p(t.width,t.height),o=w(r),i=0,u=0;return 90!==(n=n<0?360+n:n)&&270!==n||b(r,r.height,r.width),90!==n&&180!==n||(i=r.width),270!==n&&180!==n||(u=r.height),o.translate(i,u),o.rotate(n*Math.PI/180),o.drawImage(t,0,0),z(r,e)}(n,t.getType(),e)}))}function G(t,e){return t.toCanvas().then((function(n){return function(t,e,n){var r=p(t.width,t.height),o=w(r);return"v"===n?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0)),z(r,e)}(n,t.getType(),e)}))}var J=G,K=$,V=Object.keys,W=function(t,e,n){return void 0===n&&(n=!1),new U((function(r){var o=new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState&&r({status:o.status,blob:o.response})},o.open("GET",t,!0),o.withCredentials=n,function(t,e){for(var n=V(t),r=0,o=n.length;r<o;r++){var i=n[r];e(t[i],i)}}(e,(function(t,e){o.setRequestHeader(e,t)})),o.responseType="blob",o.send()}))},X=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],Q=[{type:"not_found",message:"Failed to load image."},{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Y=function(t,e){var n,r,o=(n=function(t,e){return g(t)?t[e]:void 0},r=t,function(t,e){for(var n=0,r=t.length;n<r;n++)e(t[n],n)}(e,(function(t){r=n(r,t)})),r);return h.from(o)},Z=function(t){var e,n=(e=t,"ImageProxy HTTP error: "+F(X,(function(t){return e===t.code})).fold(c("Unknown ImageProxy error"),(function(t){return t.message})));return U.reject(n)},tt=function(t){return F(Q,(function(e){return e.type===t})).fold(c("Unknown service error"),(function(t){return t.message}))},et=function(t){return"ImageProxy Service error: "+function(t){try{return h.some(JSON.parse(t))}catch(e){return h.none()}}(t).bind((function(t){return Y(t,["error","type"]).map(tt)})).getOr("Invalid JSON in service error message")},nt=function(t){return e=t,new U((function(t,n){var r=new FileReader;r.onload=function(){t(r.result)},r.onerror=function(t){n(t)},r.readAsText(e)})).then((function(t){var e=et(t);return U.reject(e)}));var e},rt=function(t){return t<200||300<=t},ot=function(t,e){var n,r,o,i={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return W((r=e,o=-1===(n=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(n)?n:n+o+"apiKey="+encodeURIComponent(r)),i).then((function(t){return rt(t.status)?(e=t.status,n=t.blob,r=e,"application/json"!==(null==(o=n)?void 0:o.type)||400!==r&&403!==r&&404!==r&&500!==r?Z(e):nt(n)):U.resolve(t.blob);var e,n,r,o}))},it=function(t,e,n){return void 0===n&&(n=!1),e?ot(t,e):W(t,{},n).then((function(t){return rt(t.status)?Z(t.status):U.resolve(t.blob)}))},ut=q,at=function(t){if(null===t||void 0===t)throw new Error("Node cannot be null or undefined");return{dom:t}},ct={fromHtml:function(t,e){var n=(e||document).createElement("div");if(n.innerHTML=t,!n.hasChildNodes()||1<n.childNodes.length)throw console.error("HTML does not have a single root node",t),new Error("HTML must have a single root node");return at(n.childNodes[0])},fromTag:function(t,e){var n=(e||document).createElement(t);return at(n)},fromText:function(t,e){var n=(e||document).createTextNode(t);return at(n)},fromDom:at,fromPoint:function(t,e,n){return h.from(t.dom.elementFromPoint(e,n)).map(at)}},st=("undefined"!=typeof window||Function("return this;")(),function(t,e){return n=function(t){return function(t,e){var n=t.dom;if(1!==n.nodeType)return!1;var r=n;if(void 0!==r.matches)return r.matches(e);if(void 0!==r.msMatchesSelector)return r.msMatchesSelector(e);if(void 0!==r.webkitMatchesSelector)return r.webkitMatchesSelector(e);if(void 0!==r.mozMatchesSelector)return r.mozMatchesSelector(e);throw new Error("Browser lacks native selectors")}(t,e)},F(t.dom.childNodes,(function(t){return n(ct.fromDom(t))})).map(ct.fromDom);var n}),ft=tinymce.util.Tools.resolve("tinymce.util.Delay"),lt=tinymce.util.Tools.resolve("tinymce.util.Promise"),dt=tinymce.util.Tools.resolve("tinymce.util.URI"),mt=function(t){return t.getParam("imagetools_proxy")};function ht(t){var e,n;function r(t){return/^[0-9\.]+px$/.test(t)}return e=t.style.width,n=t.style.height,e||n?r(e)&&r(n)?{w:parseInt(e,10),h:parseInt(n,10)}:null:(e=t.width,n=t.height,e&&n?{w:parseInt(e,10),h:parseInt(n,10)}:null)}function gt(t){return{w:t.naturalWidth,h:t.naturalHeight}}var vt=0,pt=function(t){return st(ct.fromDom(t),"img")},yt=function(t,e){return t.dom.is(e,"figure")},wt=function(t,e){var n=function(e){return n=e,t.dom.is(n,"img:not([data-mce-object],[data-mce-placeholder])")&&(Tt(t,e)||_t(t,e)||mt(t));var n};return yt(t,e)?pt(e).map((function(t){return n(t.dom)?h.some(t.dom):h.none()})):n(e)?h.some(e):h.none()},bt=function(t,e){t.notificationManager.open({text:e,type:"error"})},It=function(t){var e=t.selection.getNode();return yt(t,e)?pt(e):h.some(ct.fromDom(e))},Tt=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new dt(n).host===t.documentBaseURI.host},_t=function(t,e){return-1!==u.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new dt(e.src).host)},Rt=function(t,e){if(_t(t,e))return it(e.src,null,(n=t,r=e,-1!==u.inArray(n.getParam("imagetools_credentials_hosts",[],"string[]"),new dt(r.src).host)));var n,r,o;if(Tt(t,e))return D(e);var i=mt(t),a=i+(-1===i.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),c=(o=t).getParam("api_key",o.getParam("imagetools_api_key","","string"),"string");return it(a,c,!1)},Ut=function(t,e){return n=t,h.from(n.getParam("imagetools_fetch_image",null,"function")).fold((function(){return Rt(t,e)}),(function(t){return t(e)}));var n},At=function(t,e){var n=t.editorUpload.blobCache.getByUri(e.src);return n?lt.resolve(n.blob()):Ut(t,e)},Et=function(t){ft.clearTimeout(t.get())},jt=function(t,e,n,r,o,i){return e.toBlob().then((function(u){var a,c,s,f,l=t.editorUpload.blobCache,d=o.src;return t.getParam("images_reuse_filename",!1,"boolean")&&(a=(c=l.getByUri(d))?(d=c.uri(),c.name()):(s=t,(f=d.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?s.dom.encode(f[1]):null)),c=l.create({id:"imagetools"+vt++,blob:u,base64:e.toBase64(),uri:d,name:a}),l.add(c),t.undoManager.transact((function(){t.$(o).on("load",(function e(){var i,u,a;t.$(o).off("load",e),t.nodeChanged(),n?t.editorUpload.uploadImagesAuto():(Et(r),i=t,u=r,a=ft.setEditorTimeout(i,(function(){i.editorUpload.uploadImagesAuto()}),i.getParam("images_upload_timeout",3e4,"number")),u.set(a))})),i&&t.$(o).attr({width:i.w,height:i.h}),t.$(o).attr({src:c.blobUri()}).removeAttr("data-mce-src")})),c}))},xt=function(t,e,n,r){return function(){return It(t).fold((function(){bt(t,"Could not find selected image")}),(function(o){return t._scanForImages().then((function(){return At(t,o.dom)})).then(ut).then(n).then((function(n){return jt(t,n,!1,e,o.dom,r)}),(function(e){bt(t,e)}))}))}},Lt=function(t,e,n){return function(){var r=It(t).fold((function(){return null}),(function(t){var e=ht(t.dom);return e?{w:e.h,h:e.w}:null}));return xt(t,e,(function(t){return K(t,n)}),r)()}},kt=function(t,e,n){return function(){return xt(t,e,(function(t){return J(t,n)}))()}},Ct=function(t,e,n,r,o){return N(o).then((function(t){var e,i,u,a,c=gt(t);return r.w===c.w&&r.h===c.h||ht(n)&&(e=n,(i=c)&&(u=e.style.width,a=e.style.height,(u||a)&&(e.style.width=i.w+"px",e.style.height=i.h+"px",e.removeAttribute("data-mce-style")),u=e.width,a=e.height,(u||a)&&(e.setAttribute("width",i.w),e.setAttribute("height",i.h)))),URL.revokeObjectURL(t.src),o})).then(ut).then((function(r){return jt(t,r,!0,e,n)}),(function(){}))},Ot=function(t,e){return function(){var n=It(t),r=n.map((function(t){return gt(t.dom)}));It(t).each((function(o){wt(t,o.dom).each((function(i){At(t,o.dom).then((function(o){var i,u={blob:i=o,url:URL.createObjectURL(i)};t.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:u}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(o){var i=o.getData().imagetools.blob;n.each((function(n){r.each((function(r){Ct(t,e,n.dom,r,i)}))})),o.close()},onCancel:function(){},onAction:function(t,e){switch(e.name){case"save-state":e.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})}))}))}))}};i.add("imagetools",(function(t){var e,n,r,i,a,c,s,f,l=o(0),d=o(null);e=t,n=l,u.each({mceImageRotateLeft:Lt(e,n,-90),mceImageRotateRight:Lt(e,n,90),mceImageFlipVertical:kt(e,n,"v"),mceImageFlipHorizontal:kt(e,n,"h"),mceEditImage:Ot(e,n)},(function(t,n){e.addCommand(n,t)})),i=function(t){return function(){return r.execCommand(t)}},(r=t).ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:i("mceImageRotateLeft")}),r.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:i("mceImageRotateRight")}),r.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:i("mceImageFlipVertical")}),r.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:i("mceImageFlipHorizontal")}),r.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:i("mceEditImage"),onSetup:function(t){var e=function(){It(r).each((function(e){var n=wt(r,e.dom).isNone();t.setDisabled(n)}))};return r.on("NodeChange",e),function(){r.off("NodeChange",e)}}}),r.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image",onAction:i("mceImage")}),r.ui.registry.addContextMenu("imagetools",{update:function(t){return wt(r,t).fold((function(){return[]}),(function(t){return[{text:"Edit image",icon:"edit-image",onAction:i("mceEditImage")}]}))}}),(a=t).ui.registry.addContextToolbar("imagetools",{items:a.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions"),predicate:function(t){return wt(a,t).isSome()},position:"node",scope:"node"}),s=l,f=d,(c=t).on("NodeChange",(function(t){var e=f.get();e&&e.src!==t.element.src&&(Et(s),c.editorUpload.uploadImagesAuto(),f.set(null)),wt(c,t.element).each(f.set)}))}))}();